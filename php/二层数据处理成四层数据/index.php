<?php
/*
未处理的二层数据
Array
(
    [0] => Array
        (
            [coursesubject_id] => 115
            [description_en] =>
            [tutor_subject] => Array
                (
                    [0] => Array
                        (
                            [ID] => 65
                            [TutorNo] => T10003
                            [Subject] => 115
                            [Level] => 3
                            [CourseNo] => 33
                            [Location] => 026
                            [StudentCount] => 1
                            [StartDate] => 2007-01-01
                            [EndDate] => 2099-12-31
                            [StartTime] => 09:00:00
                            [EndTime] => 15:00:00
                            [Weekday] => 0
                            [Room] => 023D01
                            [Lunch] => 0
                            [CreatedDate] => 2015-06-21 17:12:43
                            [branch_id] => 26
                            [branch_ref_id] => 026
                            [branch_display] => Y
                            [branch_order] => 14
                            [branch_code] => DMP
                            [branch_name_en] => Domain Branch
                            [branch_name_tc] => 大本型分行
                        )
                    [1] => Array
                        (
                            [ID] => 65
                            [TutorNo] => T10003
                            [Subject] => 115
                            [Level] => 3
                            [CourseNo] => 33
                            [Location] => 026
                            [StudentCount] => 1
                            [StartDate] => 2007-01-01
                            [EndDate] => 2099-12-31
                            [StartTime] => 09:00:00
                            [EndTime] => 15:00:00
                            [Weekday] => 0
                            [Room] => 023D01
                            [Lunch] => 0
                            [CreatedDate] => 2015-06-21 17:12:43
                            [branch_id] => 26
                            [branch_ref_id] => 026
                            [branch_display] => Y
                            [branch_order] => 14
                            [branch_code] => DMP
                            [branch_name_en] => Domain Branch
                            [branch_name_tc] => 大本型分行
                        )
                    [2] => Array
                        (
                            [ID] => 65
                            [TutorNo] => T10003
                            [Subject] => 115
                            [Level] => 3
                            [CourseNo] => 33
                            [Location] => 026
                            [StudentCount] => 1
                            [StartDate] => 2007-01-01
                            [EndDate] => 2099-12-31
                            [StartTime] => 09:00:00
                            [EndTime] => 15:00:00
                            [Weekday] => 0
                            [Room] => 023D01
                            [Lunch] => 0
                            [CreatedDate] => 2015-06-21 17:12:43
                            [branch_id] => 26
                            [branch_ref_id] => 026
                            [branch_display] => Y
                            [branch_order] => 14
                            [branch_code] => DMP
                            [branch_name_en] => Domain Branch
                            [branch_name_tc] => 大本型分行
                        )

                )

        )
)

处理完的四层数据
Array
(
    [0] => Array
        (
            [coursesubject_id] => 115
            [coursesubject_category] => 12
            [Code] => 333222
            [Description_en] =>
            [Description_tc] => 口语发音练习课
            [coursesubject_agefrom] => 1
            [coursesubject_ageto] => 10
            [coursesubject_location] =>
            [coursesubject_course] => 22
            [Disable] => 0
            [CreatedDate] => 2015-06-21 18:15:10
            [coursesubject_crt_by] => 0
            [coursesubject_upd_date] => 0000-00-00 00:00:00
            [coursesubject_upd_by] => 0
            [coursesubject_status] => A
            [ID] => 22
            [CourseNumber] => UE-C10005
            [CourseType] => 1
            [Subject] => 333222
            [Level] => 21
            [course_title_tc] => 鋼5
            [course_title_en] =>
            [course_section] => 5
            [course_subsection] => 24
            [ProgramNo] => 3
            [NoOfLesson] => 4
            [Duration] => 45
            [PaymentTerms] => 1
            [Price] => 1
            [course_desc_tc] =>
            [course_desc_en] =>
            [course_photo] =>
            [Status] => A
            [tutor_subject] => Array
                (
                    [0] => Array
                        (
                            [data] => Array
                                (
                                    [0] => Array
                                        (
                                            [0] => Array
                                                (
                                                    [ID] => 65
                                                    [TutorNo] => T10003
                                                    [Subject] => 115
                                                    [Level] => 3
                                                    [CourseNo] => 33
                                                    [Location] => 026
                                                    [StudentCount] => 1
                                                    [StartDate] => 2007-01-01
                                                    [EndDate] => 2099-12-31
                                                    [StartTime] => 09:00:00
                                                    [EndTime] => 15:00:00
                                                    [Weekday] => 0
                                                    [Room] => 023D01
                                                    [Lunch] => 0
                                                    [CreatedDate] => 2015-06-21 17:12:43
                                                    [branch_id] => 26
                                                    [branch_ref_id] => 026
                                                    [branch_display] => Y
                                                    [branch_order] => 14
                                                    [branch_code] => DMP
                                                    [branch_name_en] => Domain Branch
                                                    [branch_name_tc] => 大本型分行
                                                    [branch_short_name_en] => Yau Tong Branch
                                                    [branch_short_name_tc] => 油塘分行
                                                    [branch_area] => KLN
                                                    [branch_district] => 21
                                                    [branch_address_en] => Shop 314 Domain, 38 Ko Chiu Road, Yau Tong, Kowloon.
                                                    [branch_address_tc] => 九龍油塘高超道38號大本型314號舖
                                                    [branch_tel] => 2755 7688
                                                    [branch_openhour_en] => Mon-Thur 11:00-21:30
 Fri-Sat 9:00 - 21:30
 Sun 9:00-19:00
                                                    [branch_openhour_tc] => Mon-Thur 11:00-21:30
 Fri-Sat 9:00 - 21:30
 Sun 9:00-19:00
                                                    [branch_photo] => 20130309165933.0.jpg
                                                    [branch_itude] => 22.297673621084492,114.23769298437503
                                                    [branch_geozoom] => 17
                                                    [branch_crt_date] => 2013-03-09 17:02:11
                                                    [branch_crt_by] => 2
                                                    [branch_upd_date] => 2013-03-09 17:02:11
                                                    [branch_upd_by] => 2
                                                    [branch_status] => A
                                                )

                                        )

                                    [1] => Array
                                        (
                                            [0] => Array
                                                (
                                                    [ID] => 66
                                                    [TutorNo] => T10001
                                                    [Subject] => 115
                                                    [Level] => 3
                                                    [CourseNo] => 33
                                                    [Location] => 027
                                                    [StudentCount] => 1
                                                    [StartDate] => 2007-01-01
                                                    [EndDate] => 2099-12-31
                                                    [StartTime] => 09:00:00
                                                    [EndTime] => 15:00:00
                                                    [Weekday] => 0
                                                    [Room] => 023D01
                                                    [Lunch] => 0
                                                    [CreatedDate] => 2015-06-21 17:09:36
                                                    [branch_id] => 27
                                                    [branch_ref_id] => 027
                                                    [branch_display] => Y
                                                    [branch_order] => 1
                                                    [branch_code] => PSC
                                                    [branch_name_en] => Piano Selection Centre
                                                    [branch_name_tc] => 選琴中心
                                                    [branch_short_name_en] => Piano Selection Centre
                                                    [branch_short_name_tc] => 選琴中心
                                                    [branch_area] => KLN
                                                    [branch_district] => 22
                                                    [branch_address_en] => 11/F, Gemstar Tower, 23 Man Lok Street, Hung Hom, Kowloon, Hong Kong
                                                    [branch_address_tc] => 香港九龍紅磡民樂街23號駿昇中心11樓
                                                    [branch_tel] => 3519 2300
                                                    [branch_openhour_en] => Mon-Sat 9:00 - 18:00
                                                    [branch_openhour_tc] => Mon-Sat 9:00 - 18:00
                                                    [branch_photo] => 20130424093130.27.jpg
                                                    [branch_itude] => 22.309277321296648,114.18994966390994
                                                    [branch_geozoom] => 17
                                                    [branch_crt_date] => 2013-04-23 14:55:34
                                                    [branch_crt_by] => 2
                                                    [branch_upd_date] => 2013-04-24 09:41:08
                                                    [branch_upd_by] => 2
                                                    [branch_status] => A
                                                )

                                            [1] => Array
                                                (
                                                    [ID] => 67
                                                    [TutorNo] => T10005
                                                    [Subject] => 115
                                                    [Level] =>
                                                    [CourseNo] =>
                                                    [Location] => 027
                                                    [StudentCount] => 0
                                                    [StartDate] => 2015-06-19
                                                    [EndDate] => 2015-06-22
                                                    [StartTime] => 00:00:00
                                                    [EndTime] => 00:00:00
                                                    [Weekday] => 0
                                                    [Room] =>
                                                    [Lunch] => 0
                                                    [CreatedDate] => 2015-06-20 15:30:51
                                                    [branch_id] => 27
                                                    [branch_ref_id] => 027
                                                    [branch_display] => Y
                                                    [branch_order] => 1
                                                    [branch_code] => PSC
                                                    [branch_name_en] => Piano Selection Centre
                                                    [branch_name_tc] => 選琴中心
                                                    [branch_short_name_en] => Piano Selection Centre
                                                    [branch_short_name_tc] => 選琴中心
                                                    [branch_area] => KLN
                                                    [branch_district] => 22
                                                    [branch_address_en] => 11/F, Gemstar Tower, 23 Man Lok Street, Hung Hom, Kowloon, Hong Kong
                                                    [branch_address_tc] => 香港九龍紅磡民樂街23號駿昇中心11樓
                                                    [branch_tel] => 3519 2300
                                                    [branch_openhour_en] => Mon-Sat 9:00 - 18:00
                                                    [branch_openhour_tc] => Mon-Sat 9:00 - 18:00
                                                    [branch_photo] => 20130424093130.27.jpg
                                                    [branch_itude] => 22.309277321296648,114.18994966390994
                                                    [branch_geozoom] => 17
                                                    [branch_crt_date] => 2013-04-23 14:55:34
                                                    [branch_crt_by] => 2
                                                    [branch_upd_date] => 2013-04-24 09:41:08
                                                    [branch_upd_by] => 2
                                                    [branch_status] => A
                                                )

                                        )

                                )

                            [tutor_subject_branch_area_tc] => 九龙分行
                        )

                )

        )
)


smarty示例
<{section name=r loop=$searchResultData}>
	<li>
		<table border="0" cellpadding="0" cellspacing="0">
			<tr>
				<td class="td3">課程名稱</td>
				<td>小小莫札特BB教室 - <a href="#">小小莫札特音樂教室</a></td>
				<td rowspan="4" width="133">
					<div class="class_face"><a href="#"><img src="thumbs/134x90/1/materials/course/<{$searchResultData[r].course_photo}>"/></a>
					</div>
				</td>
			</tr>
			<tr>
				<td>科目</td>
				<td><{$searchResultData[r].cateinfo.category_name_tc}></td>
			</tr>
			<tr>
				<td>年齡</td>
				<td><{$searchResultData[r].course_agefrom}>歲 - <{$searchResultData[r].course_ageto}><{if $searchResultData[r].course_ageto eq 18}>+<{/if}>歲 </td>
			</tr>
			<tr>
				<td>學費</td>
				<td>$<{$searchResultData[r].Price}></td>
			</tr>
			<tr>
				<td>課程號</td>
				<td><{$searchResultData[r].CourseNumber}></td>
			</tr>
			<tr>
				<td>課程簡介</td>
				<td><{$searchResultData[r].course_desc_tc}></td>
			</tr>
			<tr>
				<td colspan="2"><a href="javascript:;" class="button2"><span>開班時間表</span></a>
				</td>
			</tr>
			<tr>
				<td colspan="3" style="display:none;">
					<{foreach from=$searchResultData[r]['tutor_subject'] item=tutor_branch_data}>
						<table width="100%" border="0" cellspacing="1" cellpadding="0"
							   class="schedule">
							<tr>
								<th scope="col"><{$tutor_branch_data['tutor_subject_branch_area_tc']}></th>
								<th scope="col">查詢電話</th>
								<th scope="col" style="width:30px;">星期</th>
								<th scope="col">時間</th>
								<th scope="col">開班日期</th>
								<th scope="col" class="last">即時報名</th>
							</tr>
							<{foreach from=$tutor_branch_data['data'] item=tutor_subject_data}>
								<{section loop=$tutor_subject_data name=tutor_subject_data_index}>
									<tr>
										<{if $smarty.section.tutor_subject_data_index.index == 0}>
											<td rowspan="<{$smarty.section.tutor_subject_data_index.total}>"><{$tutor_subject_data[tutor_subject_data_index]['branch_name_tc']}></td>
											<td rowspan="<{$smarty.section.tutor_subject_data_index.total}>"><{$tutor_subject_data[tutor_subject_data_index]['branch_tel']}></td>
										<{/if}>
										<td style="width:30px;"><{$tutor_subject_data[tutor_subject_data_index]['Weekday']}></td>
										<td><{$tutor_subject_data[tutor_subject_data_index]['StartTime']}> - <{$tutor_subject_data[tutor_subject_data_index]['EndTime']}></td>
										<td><{$tutor_subject_data[tutor_subject_data_index]['StartDate']}></td>
										<td class="last"><a data-categorysubjectid="<{$searchResultData[r].coursesubject_id}>" data-tutorsubjectid="<{$tutor_subject_data[tutor_subject_data_index]['ID']}>" class="button3 signup">報名</a></td>
									</tr>
								<{/section}>
							<{/foreach}>
						</table>
					<{/foreach}>
				</td>
			</tr>
		</table>
	</li>
<{/section}>
 * */
/*
 * 处理查找的数据 把两层数据按照内部分类处理成四层
 * */
public function handleSearchResultData($searchResultData=array())
{
    /* 为了减少smarty的判断逻辑 这里把分类修改成数组 */
    foreach ($searchResultData as $searchResultDataKey => $searchResultDataValue) {
        /* 先按branch_area字段分类到数组 */
        $tutorArr=array();
        foreach ($searchResultDataValue['tutor_subject'] as $tutorSubjectKey => $tutorSubjectValue) {
            if($tutorSubjectValue['branch_area']=='KLN'){
                $tutorArr['KLN'][]=$tutorSubjectValue;
            }elseif($tutorSubjectValue['branch_area']=='HK'){
                $tutorArr['HK'][]=$tutorSubjectValue;
            }elseif($tutorSubjectValue['branch_area']=='NT'){
                $tutorArr['NT'][]=$tutorSubjectValue;
            }
        }
        /* 把按字段分完的数组重新按顺序拼合到新数组 */
        $tutorResultArr=array();
        if(isset($tutorArr['KLN'])){
            $tempArr=array();
            $tempArr['data'] = $tutorArr['KLN'];
            $tempArr['tutor_subject_branch_area_tc'] = '九龙分行';
            $tutorResultArr[]=$tempArr;
        }
        if(isset($tutorArr['HK'])){
            $tempArr=array();
            $tempArr['data'] = $tutorArr['HK'];
            $tempArr['tutor_subject_branch_area_tc'] = '港岛分行';
            $tutorResultArr[]=$tempArr;
        }
        if(isset($tutorArr['NT'])){
            $tempArr=array();
            $tempArr['data'] = $tutorArr['NT'];
            $tempArr['tutor_subject_branch_area_tc'] = '新界分行';
            $tutorResultArr[]=$tempArr;
        }
        /* 把新数据赋值回总数组 */
        $searchResultData[$searchResultDataKey]['tutor_subject']=$tutorResultArr;
    }

    foreach ($searchResultData as $searchResultDataKey => $searchResultDataValue) {
        foreach ($searchResultDataValue['tutor_subject'] as $tutorSubjectKey => $tutorSubjectValue) {
            /* 进入到第四层 先按branch_id字段分类到数组 */
            $tutorArr=array();
            foreach ($tutorSubjectValue['data'] as $tutorDataKey => $tutorDataValue) {
                $tutorArr[$tutorDataValue['branch_id']][] = $tutorDataValue;
            }
            /* 把按字段分完的数组重新按顺序拼合到新数组 到这里实现的功能类似于 group by branch_id */
            $tutorResultArr = array();
            foreach ($tutorArr as $row) {
                $tutorResultArr[] = $row;
            }
            $tutorSubjectValue['data'] = $tutorResultArr;
        }
        /* 把新数据赋值回总数组 */
        $searchResultData[$searchResultDataKey]['tutor_subject'][$tutorSubjectKey]=$tutorSubjectValue;
    }

    return $searchResultData;
}